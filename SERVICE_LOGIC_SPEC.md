# 服务运算逻辑规范文档

## 📋 当前架构确认

✅ **方案A已实现**：
- 所有服务统一指向：`POST https://caculateforn8n-production.up.railway.app/process`
- 前端发送 FormData：`file` + `input_text` + `service_id`
- 后端根据 `service_id` 做分发处理

---

## 🎯 三个服务的 Service ID

根据 Supabase 数据库，当前有3个服务：

| 服务名称 | Service ID | 当前状态 |
|---------|-----------|---------|
| **Ex大名)** | `abfaf85c-9553-4d7b-9416-e3aff65e8587` | 需要实现逻辑 |
| **筛选核心关键词** | `d144da99-d3e6-4b78-9cd5-70b1e4ced346` | 需要实现逻辑 |
| **计算投产比** | `65bb6f50-5087-488e-8f1b-350d4ed9fe00` | 需要实现逻辑 |

---

## 📝 请为每个服务填写以下信息

### 服务1：Ex大名)

**Service ID**: `abfaf85c-9553-4d7b-9416-e3aff65e8587`

#### 1. 输入要求
- [ ] 需要文件上传（Excel/CSV）
- [ ] 需要文本输入（`input_text`）
- [ ] 两者都需要

#### 2. 文件格式要求
- 文件类型：`_____________`（如：.xlsx, .csv, .zip）
- 必需列名：`_____________`（如：姓名、日期、金额）
- 数据格式要求：`_____________`

#### 3. 运算逻辑描述
请详细描述这个服务需要做什么：

```
示例：
1. 读取 Excel 文件的第1列（关键词列）
2. 根据 input_text 中的关键词列表进行筛选
3. 筛选出包含任一关键词的行
4. 添加"筛选状态"列，标记为"已筛选"
5. 导出为新的 Excel 文件
```

**你的逻辑**：
```
[请在这里描述]
```

#### 4. 输出要求
- [ ] 返回 Excel 文件（.xlsx）
- [ ] 返回 JSON 文本
- [ ] 其他格式：`_____________`

#### 5. 代码示例（如果有）
如果你有现有的 Python/Pandas 代码，可以粘贴在这里：

```python
# [粘贴你的代码]
```

---

服务2：筛选核心关键词

Service ID: d144da99-d3e6-4b78-9cd5-70b1e4ced346

1. 输入要求

 需要文件上传（Excel/CSV）

 需要文本输入（input_text）

 两者都需要

2. 文件格式要求

文件类型：.xlsx / .csv

必需列名（至少满足其一）：

关键词列：关键词 或 A

相关产品列：相关产品 或 G

ABA 周排名列：ABA周排名 或 I

数据格式要求：

“相关产品”列优先解析为数值，无法解析的视为无效数值

“ABA周排名”列不能为空，且不能为 -、—、NA、N/A、null（大小写不敏感）

3. 运算逻辑描述

本服务用于从关键词数据中筛选出一组核心关键词，运算逻辑完全基于固定排序与过滤规则，不依赖任何外部参数。

1. 读取 Excel 数据
2. 按“相关产品（G 列）”进行降序排序：
   - 优先按数值进行排序
   - 无法解析为数值的视为最小值（始终排在最后）
   - 若排序的两条数据均无法解析为数值，则按字符串（中文 locale）降序排序
3. 删除“ABA周排名（I 列）”为空或无效的行：
   - null / undefined
   - 空字符串
   - -、—、NA、N/A、null（大小写不敏感）
4. 在排序并过滤后的结果中，取前 60 行数据
5. 从每一行中提取关键词字段，仅保留关键词列作为最终结果输出

4. 输出要求

 返回 Excel 文件（.xlsx）

 返回 JSON 文本

 其他格式：_____________

5. 代码示例（如果有）
# 该服务的计算逻辑以排序、过滤、截断为主
# 具体实现以 FastAPI 中 process_dataframe 函数为准


### 服务3：计算投产比

**Service ID**: `65bb6f50-5087-488e-8f1b-350d4ed9fe00`

#### 1. 输入要求
- [x] 需要文件上传（Excel/CSV）
- [ ] 需要文本输入（`input_text`）
- [ ] 两者都需要

#### 2. 文件格式要求
- 文件类型：`.xlsx` / `.xls` / `.csv`
- 必需列名（至少满足其一）：
  - 周点击量列：`周点击量` 或 `点击量` 或 `Clicks`
  - 周购买量列：`周购买量` 或 `购买量` 或 `Purchases`
  - 竞价列：`竞价` 或 `Bid` 或 `出价`
  - 产品均价列：`产品均价` 或 `客单价` 或 `Price` 或 `平均价格`
- 数据格式要求：
  - 数值字段支持逗号分隔符（会自动清洗）
  - 无法解析的数值按 0 处理

#### 3. 运算逻辑描述

✅ **已实现**，逻辑如下：

1. 读取 Excel 数据并逐行遍历
2. 对以下字段进行数值清洗：
   - 去除逗号
   - 转换为数值
   - 无法解析的值按 0 处理
3. 累加计算全表数据：
   - 总点击量 = 所有行"周点击量"之和
   - 总购买量 = 所有行"周购买量"之和
4. 计算加权竞价分子：
   - 当某一行的点击量 > 0 且竞价 > 0 时
   - 累加 (竞价 × 点击量)
5. 在遍历过程中，读取第一个大于 0 的"产品均价"作为参考客单价
6. 防止除以 0：
   - 若总点击量为 0，则按 1 处理
   - 若客单价为 0，则按 1 处理
7. 计算核心指标：
   - 平均转化率 (%) = (总购买量 ÷ 总点击量) × 100
   - 加权平均竞价 = (竞价 × 点击量之和) ÷ 总点击量
   - 预估 ACOS (%) = 加权平均竞价 ÷ (客单价 × 转化率) × 100
8. 将上述计算结果整理为一段文本分析报告

#### 4. 输出要求
- [ ] 返回 Excel 文件（.xlsx）
- [x] 返回 JSON 文本（包含分析报告）
- [ ] 其他格式：`_____________`

#### 5. 代码示例（如果有）
✅ **已实现**，代码位置：`python-backend/main.py` 中的 `calculate_roi()` 函数

---

## 🚀 如何提供逻辑

你可以通过以下方式提供运算逻辑：

### 方式1：文字描述（推荐）
直接在文档中填写上面的表格，我会根据描述实现代码。

### 方式2：提供现有代码
如果你有现有的 Python/Pandas 代码，直接粘贴到"代码示例"部分。

### 方式3：提供示例文件
- 上传一个示例输入文件（Excel/CSV）
- 上传一个期望的输出文件（Excel/CSV）
- 我会分析差异，推断出运算逻辑

### 方式4：提供详细步骤
列出每一步的具体操作，例如：
1. 读取第1列数据
2. 删除空行
3. 根据条件筛选
4. 计算新列
5. 导出结果

---

## 📌 当前 FastAPI 代码位置

代码文件：`python-backend/main.py`

关键函数：`process_dataframe(df, service_id, input_text)`

当前实现（第130-165行）：
```python
def process_dataframe(df: pd.DataFrame, service_id: Optional[str], input_text: Optional[str]) -> pd.DataFrame:
    """根据服务ID执行不同的数据处理逻辑"""
    result_df = df.copy()
    
    if service_id == "abfaf85c-9553-4d7b-9416-e3aff65e8587":  # Ex大名)
        # [需要实现]
        
    elif service_id == "d144da99-d3e6-4b78-9cd5-70b1e4ced346":  # 筛选核心关键词
        # [需要实现]
        
    elif service_id == "65bb6f50-5087-488e-8f1b-350d4ed9fe00":  # 计算投产比
        # [需要实现]
    
    return result_df
```

---

## ✅ 填写完成后

填写完这个文档后，告诉我：
1. "我已经填写好了 SERVICE_LOGIC_SPEC.md"
2. 我会读取文档并实现代码
3. 你可以测试每个服务的逻辑是否正确

